

# zookeeper

**主要应用：**

* 分布式协调：A系统注册监听一个节点，B系统改变该节点，A系统收到通知做出反应。
* 分布式锁。
* 元数据/配置信息管理：像微服务的注册信息。
* HA高可用性：主备两个，主的挂了通过zookeeper系统切换到备。

**Zxid**：ZK节点改变都产生唯一的Zxid，有cZxid(创建时间对于的Zxid格式时间戳)和mZxid(修改时间)。

每次新的领导者选举出来，Zxid的高32位就记录着这个领导者。低32位用于递增计数。

**角色**：Leader（投票的发起和决议，更新系统状态）、Follower（接收客户端和返回结果、选主时投票）、Observer（接受客户端连接，将写请求转发给leader。不参与投票，只同步leader状态。目的是为了拓展系统，提高读取速度）。

**作用**：1、命名服务。2、配置管理。3、集群管理。4、分布式锁。5、队列管理。

**通知机制**：client端会对某个znode建立一个watcher事件，当该znode发生变化时，这些client会收到zk的通知，然后client可以根据znode变化来做业务上的改变等。

**Zab协议**：Zookeeper的核心是原子广播，保证了各个Server之间的同步，这协议有两种模式，恢复模式（选主）和广播模式（同步）。服务启动和领导者奔溃，Zab进入恢复模式，选举出领导者，且大多数Server完成和leader的状态同步以后，恢复模式就结束了，保证leader和Server具有相同状态。

**每个Server工作过程三个状态**：looking（找领导）、leading（成为领导）、following（同步）。

**写**：client对任意一个follower发起写请求，该follwer将信息发给leader，leader发起一个Proposal(提议)要求所有follower投票，通过最新同步完成，回复原follower响应到client。

**选主**：无非是每个server发出自己的Zxid，然后最大的Server被拉出来投票。

**同步流程**：Follower连接leader发送Zxid，leader确定同步点发送同步消息，follower同步完成修改自己和回复。

**Paxos算法**：通过投票对写操作进行全局编号。同一个时刻，只有一个写操作被批准，同时并发的写操作要去争取选票，只有超过半数选票的写操作才会被批准（所以永远只有一个写操作被批准），其他来的写操作只好发起一轮投票，就这样无时无刻地投票中，所有的写操作都被严格编号排序，严格递增。例如编号100的写操作之后，又来了一个编号99的写操作，Server就知道有问题停止服务重启同步。

参考自：https://www.cnblogs.com/raphael5200/p/5285583.html